# å¤šåˆ†å­ç°‡é‡‡æ ·ç³»ç»Ÿ - å®Œæ•´æ–‡æ¡£

> **ç‰ˆæœ¬**: 2.0 | **æ—¥æœŸ**: 2026-01-15
> 
> **åŠŸèƒ½**: å¤šåˆ†å­æ··åˆèšç±»åˆå§‹ç»“æ„ç”Ÿæˆ + PT é…¯æ ¸å¿ƒæ”¾ç½®ç­–ç•¥ + åå¤„ç†è¿‡æ»¤
>
> **ğŸŒ è¯­è¨€ç‰ˆæœ¬**: [English](FULL_DOCUMENTATION_EN.md) | ä¸­æ–‡

---

## ç›®å½•

1. [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
2. [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
3. [æ ¸å¿ƒç®—æ³•](#æ ¸å¿ƒç®—æ³•)
4. [PT ç‰¹æ®Šç­–ç•¥](#pt-ç‰¹æ®Šç­–ç•¥)
5. [åå¤„ç†è¿‡æ»¤](#åå¤„ç†è¿‡æ»¤)
6. [é…ç½®ä¸å‚æ•°](#é…ç½®ä¸å‚æ•°)
7. [ä½¿ç”¨ç¤ºä¾‹](#ä½¿ç”¨ç¤ºä¾‹)
8. [æ·»åŠ æ–°åˆ†å­](#æ·»åŠ æ–°åˆ†å­)
9. [æ•°å­¦åŸç†](#æ•°å­¦åŸç†)
10. [æ•…éšœæ’é™¤](#æ•…éšœæ’é™¤)

---

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨é¢„è®¾é…ç½®ï¼ˆæ¨èï¼‰

```bash
# åˆ—å‡ºå¯ç”¨åˆ†å­
python main.py --list-monomers

# é€‰æ‹©åˆ†å­å¹¶ç”Ÿæˆ
python main.py --use "PT,H2SO4,NO2" --nseeds 100

# è‡ªå®šä¹‰æ•°é‡
python main.py --use "PT,H2SO4,NO,NO2" \
  --counts "PT=2,H2SO4=1,NO=2,NO2=1" --nseeds 200
```

### æ–¹å¼äºŒï¼šä½¿ç”¨ JSON é…ç½®

```bash
python main.py --config config.json --nseeds 100
```

### æ–¹å¼ä¸‰ï¼šå‘½ä»¤è¡Œå‚æ•°å¾®è°ƒ

```bash
python main.py --use "PT,H2SO4" \
  --dmin 8.0 --dmax 11.0 --lateral 1.5 \
  --enable_filter --nseeds 50
```

---

## ç³»ç»Ÿæ¶æ„

### é¡¹ç›®ç»“æ„

```
sampling/
â”œâ”€â”€ main.py                      # å…¥å£
â”œâ”€â”€ config.json                  # ä¸»é…ç½®æ–‡ä»¶ï¼ˆ6ç§åˆ†å­ï¼Œé¢„è®¾å‚æ•°ï¼‰
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ config.py               # é…ç½®åŠ è½½ã€åˆ†å­é€‰æ‹©
â”‚   â”œâ”€â”€ sampling.py             # Head-Insert + PT ç­–ç•¥
â”‚   â””â”€â”€ extractor.py            # å¤šå¸§æ–‡ä»¶æ‹†åˆ†
â”œâ”€â”€ monomer/                     # å•ä½“åˆ†å­åº“
â”‚   â”œâ”€â”€ opt-PT-B97-3c.xyz
â”‚   â”œâ”€â”€ opt-cisSA-B97-3c.xyz    # H2SO4
â”‚   â”œâ”€â”€ opt-transSA-B97-3c.xyz
â”‚   â”œâ”€â”€ opt-NO-B97-3c.xyz
â”‚   â”œâ”€â”€ opt-NO2-B97-3c.xyz
â”‚   â””â”€â”€ opt-SO2-B97-3c.xyz
â”œâ”€â”€ out/                         # è¾“å‡ºï¼ˆè‡ªåŠ¨åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ seeds/                  # å•ä¸ªç§å­æ–‡ä»¶
â”‚   â”œâ”€â”€ seeds_xyz/              # æ‹†åˆ†åçš„ç§å­
â”‚   â””â”€â”€ seeds_PT_combined.xyz  # å¤šå¸§åˆå¹¶
â””â”€â”€ docs/
    â””â”€â”€ ALGORITHM.md            # æ•°å­¦åŸç†è¯¦è¿°
```

### æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥ â†’ é…ç½®åŠ è½½ â†’ åˆ†å­é€‰æ‹© â†’ é‡‡æ ·å¼•æ“ â†’ åå¤„ç†è¿‡æ»¤ â†’ è¾“å‡ºç§å­
   â†“           â†“          â†“          â†“             â†“            â†“
 CLIå‚æ•°   config.json  resolve   Head-Insert   filter_accept  .xyz + .xcontrol
          molecules    monomer   + PT strategy   (Rg/æ¥è§¦/å»é‡)
```

---

## æ ¸å¿ƒç®—æ³•

### Head-Insert æ”¾ç½®ç­–ç•¥

**åŸç†**ï¼šé€ä¸ªå‘ç°æœ‰èšç±»ä¸­æ·»åŠ æ–°åˆ†å­ï¼Œé€šè¿‡å¤´å‘é‡å¯¹é½å’Œè·ç¦»æ§åˆ¶ç¡®ä¿åˆç†æ¥è§¦ã€‚

#### æ­¥éª¤

1. **åˆå§‹åŒ–**ï¼šç¬¬ä¸€ä¸ªåˆ†å­æ”¾ç½®åœ¨åŸç‚¹ï¼ˆè´¨å¿ƒä¸º 0ï¼‰
2. **å¤´ç‚¹æ£€æµ‹**ï¼šæŒ‰ä¼˜å…ˆçº§é€‰æ‹©å¼‚åŸå­ï¼ˆO > N > S > å…¨éƒ¨ï¼‰
3. **å¯¹é½æ—‹è½¬**ï¼šæ–°åˆ†å­å¤´å‘é‡æŒ‡å‘é”šåˆ†å­å¤´å‘é‡çš„åæ–¹å‘
4. **è·ç¦»æ”¾ç½®**ï¼šæ²¿å¤´å‘é‡æ–¹å‘ï¼Œè·ç¦» d âˆˆ [dmin, dmax]
5. **ä¾§å‘æ‰°åŠ¨**ï¼šå‚ç›´äºä¸»è½´çš„éšæœºåç§» â‰¤ lateral
6. **æŠ–åŠ¨æ—‹è½¬**ï¼šé¢å¤– Â±jitter_deg è§’åº¦æ—‹è½¬
7. **ç¢°æ’æ£€æµ‹**ï¼šæ‰€æœ‰åŸå­å¯¹è·ç¦» > clash_cut
8. **æ¥å—/é‡è¯•**ï¼šé€šè¿‡åˆ™åŠ å…¥èšç±»ï¼Œå¦åˆ™é‡æ–°å°è¯•

#### å¤´å‘é‡å®šä¹‰

$$\mathbf{v}_h = \frac{\mathbf{h} - \mathbf{c}}{\|\mathbf{h} - \mathbf{c}\|}$$

- $\mathbf{c}$ï¼šåˆ†å­è´¨å¿ƒ
- $\mathbf{h}$ï¼šå¤´ç‚¹ï¼ˆä¼˜å…ˆå¼‚åŸå­è´¨å¿ƒï¼‰
- è‹¥å‘é‡è¿‡å°ï¼Œä½¿ç”¨è· COM æœ€è¿œçš„å¼‚åŸå­

#### é²æ£’æ€§è®¾è®¡

- **å¯¹ç§°åˆ†å­å¤„ç†**ï¼šå¼‚åŸå­è´¨å¿ƒæ¥è¿‘ COM æ—¶ï¼Œä½¿ç”¨æœ€è¿œå¼‚åŸå­
- **æ— å¼‚åŸå­åˆ†å­**ï¼šä½¿ç”¨æ‰€æœ‰åŸå­çš„æœ€è¿œç‚¹
- **é€€åŒ–æƒ…å†µ**ï¼š180Â° æ—‹è½¬é€šè¿‡å‚ç›´è½´å®ç°

---

## PT ç‰¹æ®Šç­–ç•¥

### PT é…¯æ ¸å¿ƒå®šä¹‰

PTï¼ˆäº”èµ¤è—“ç³–é†‡é…¯ï¼‰åˆ†å­å«æœ‰å¤šä¸ª O åŸå­ï¼Œè¿™äº› O åŸå­é›†ä¸­åœ¨é…¯å®˜èƒ½å›¢åŒºåŸŸã€‚

**é…¯æ ¸å¿ƒè®¡ç®—**ï¼š

$$\mathbf{p}_{\text{core}} = \frac{1}{k} \sum_{i \in I_{\text{O}}^{(k)}} \mathbf{r}_i$$

- $k$ = 8ï¼ˆé»˜è®¤ï¼‰ï¼šé€‰å–è· COM æœ€è¿‘çš„ 8 ä¸ª O åŸå­
- $I_{\text{O}}^{(k)}$ï¼šè¿™ 8 ä¸ª O åŸå­çš„ç´¢å¼•é›†
- $\mathbf{p}_{\text{core}}$ï¼šé…¯æ ¸å¿ƒç‚¹ï¼ˆç”¨äº PTâ†”PT å¯¹é½ï¼‰

### ä¸‰åˆ†æ”¯æ”¾ç½®ç­–ç•¥

#### åˆ†æ”¯ Aï¼šçº¯ PT èšç±»ï¼ˆN_PT â‰¥ 2ï¼Œæ— å…¶ä»–åˆ†å­ï¼‰

```
æµç¨‹ï¼š
1. æ”¾ç½®ç¬¬ä¸€ä¸ª PTï¼ˆåŸç‚¹ï¼‰
2. å¯¹æ¯ä¸ªæ–° PTï¼š
   - éšæœºé€‰é”šç‚¹ï¼ˆä¼˜å…ˆç°æœ‰ PTï¼‰
   - è®¡ç®—é”š PT é…¯æ ¸å¿ƒ
   - å®Œå…¨éšæœºæ—‹è½¬æ–° PT
   - æ²¿éšæœºæ–¹å‘æ”¾ç½®ï¼Œè·ç¦» d âˆˆ [dmin_PT, dmax_PT]
   - æ£€æŸ¥æ–°æ ¸å¿ƒä¸æ‰€æœ‰ç°æœ‰ PT æ ¸å¿ƒè·ç¦» â‰¤ core_dist_max
   - ç¢°æ’æ£€æµ‹
   - é€šè¿‡åˆ™åŠ å…¥
```

**è·ç¦»èŒƒå›´è‡ªé€‚åº”**ï¼š

è‹¥ `core_dist_max` è¾ƒå°ï¼ˆå¦‚ 8Ã…ï¼‰ä¸” `dmin` è¿‡å¤§ï¼ˆå¦‚ 10Ã…ï¼‰ï¼Œä¼šå¯¼è‡´å†²çªã€‚ç®—æ³•è‡ªåŠ¨è°ƒæ•´ï¼š

$$d_{\min}^{(PT)} = \min(\text{dmin}, 0.9 \times \text{core\_dist\_max})$$
$$d_{\max}^{(PT)} = \min(\text{dmax}, \text{core\_dist\_max})$$

è‹¥ä»ç„¶ $d_{\min}^{(PT)} > d_{\max}^{(PT)}$ï¼Œåˆ™ï¼š

$$d_{\min}^{(PT)} = \max(0.5 \times d_{\max}^{(PT)}, 0.1)$$

#### åˆ†æ”¯ Bï¼šå¤š PT + å…¶ä»–åˆ†å­ï¼ˆN_PT â‰¥ 2ï¼Œæœ‰é PTï¼‰

```
é˜¶æ®µ 1ï¼šæ”¾ç½®æ‰€æœ‰ PT åˆ†å­
  - ä½¿ç”¨æ ¸å¿ƒå¯¹é½ç­–ç•¥ï¼ˆåŒåˆ†æ”¯ Aï¼‰
  - ç¡®ä¿æ‰€æœ‰ PT æ ¸å¿ƒé—´è· â‰¤ core_dist_max

é˜¶æ®µ 2ï¼šæ”¾ç½®é PT åˆ†å­
  - è®¡ç®—å…¨å±€ PT æ ¸å¿ƒè´¨å¿ƒï¼špÌ„ = (1/N_PT) Î£ p_j
  - å¯¹æ¯ä¸ªé PT åˆ†å­ï¼š
    * ä¼˜å…ˆé”šå®šåˆ° PT åˆ†å­
    * ä½¿ç”¨æ ‡å‡† Head-Insertï¼ˆå¤´å‘é‡å¯¹é½ï¼‰
    * æ”¶ç´§è·ç¦»å‚æ•°ï¼ˆ0.75-0.85 å€ï¼‰
    * æ£€æŸ¥å¤´ç‚¹åˆ° pÌ„ çš„è·ç¦» â‰¤ head_core_max
    * ç¢°æ’æ£€æµ‹
```

#### åˆ†æ”¯ Cï¼šå• PT + å…¶ä»–åˆ†å­ï¼ˆN_PT = 1ï¼Œæœ‰é PTï¼‰

```
æµç¨‹ï¼š
1. æ”¾ç½® PT
2. è®¡ç®—å…¶é…¯æ ¸å¿ƒ p
3. æ”¾ç½®é PTï¼š
   - é”šå®šåˆ° PTï¼ˆä¼˜å…ˆï¼‰
   - å¤´ç‚¹éœ€æ»¡è¶³ â€–h_non-PT - pâ€– â‰¤ head_core_max
   - æ ‡å‡† Head-Insert + æ”¶ç´§è·ç¦»
```

### PT ç­–ç•¥çš„ç‰©ç†æ„ä¹‰

- **é…¯æ ¸å¿ƒèšé›†**ï¼šæ¨¡æ‹Ÿ PT åˆ†å­é—´çš„é…¯å®˜èƒ½å›¢ç›¸äº’é è¿‘å€¾å‘
- **é PT ç¯ç»•**ï¼šç¡®ä¿å…¶ä»–åˆ†å­ï¼ˆå¦‚ H2SO4, NO2ï¼‰å›´ç»• PT æ ¸å¿ƒåŒºåŸŸ
- **è·ç¦»çº¦æŸ**ï¼šé˜²æ­¢ PT åˆ†å­è¿‡åº¦åˆ†æ•£ï¼Œä¿æŒåŒ–å­¦ç›¸å…³çš„æ¥è§¦è·ç¦»

---

## åå¤„ç†è¿‡æ»¤

### å¯ç”¨è¿‡æ»¤

```bash
python main.py --use "PT,H2SO4" \
  --enable_filter \
  --min_contacts 20 \
  --max_rg 25.0 \
  --core_dist_max 8.0 \
  --head_core_max 6.0 \
  --nseeds 100
```

### å››å±‚è¿‡æ»¤è§„åˆ™

#### 1. å›æ—‹åŠå¾„ï¼ˆRadius of Gyrationï¼‰

$$\text{Rg} = \sqrt{\frac{1}{N} \sum_{i=1}^{N} \|\mathbf{r}_i - \overline{\mathbf{r}}\|^2}$$

- **æ»¤é™¤æ¡ä»¶**ï¼šRg > max_rg
- **æ„ä¹‰**ï¼šæ‹’ç»è¿‡äºåˆ†æ•£çš„èšç±»
- **æ¨èå€¼**ï¼š20.0-30.0 Ã…ï¼ˆå–å†³äºèšç±»å¤§å°ï¼‰

#### 2. åˆ†å­é—´æ¥è§¦è®¡æ•°

$$\text{contacts} = \#\{(i,j) : i < j, \text{mol}(i) \ne \text{mol}(j), \|\mathbf{r}_i - \mathbf{r}_j\| < d_{\text{contact}}\}$$

- **æ»¤é™¤æ¡ä»¶**ï¼šcontacts < min_contacts
- **æ„ä¹‰**ï¼šæ‹’ç»èšåˆåº¦ä¸è¶³çš„èšç±»
- **æ¨èå€¼**ï¼š15-25ï¼ˆå–å†³äºåˆ†å­æ•°é‡ï¼‰

#### 3. ç»“æ„å»é‡ï¼ˆRMSD æŒ‡çº¹ï¼‰

- æ„å»ºè·ç¦»åˆ†å¸ƒç›´æ–¹å›¾ï¼ˆ0-30Ã…ï¼Œ0.5Ã… åˆ†è¾¨ç‡ï¼‰
- è½¬æ¢ä¸ºå“ˆå¸Œå€¼
- **æ»¤é™¤æ¡ä»¶**ï¼šæŒ‡çº¹é‡å¤
- **æ„ä¹‰**ï¼šé¿å…å‡ ä½•é‡å¤çš„ç§å­

#### 4. PT ç‰¹å®šçº¦æŸï¼ˆä»…æ··åˆèšç±»ï¼‰

**PT-PT æ ¸å¿ƒè·ç¦»**ï¼š

$$\max_{i \ne j \in \text{PT}} \|\mathbf{p}_i - \mathbf{p}_j\| \le \text{core\_dist\_max}$$

**é PT å¤´åˆ°å…¨å±€ PT æ ¸å¿ƒè·ç¦»**ï¼š

$$\forall i \notin \text{PT}, \quad \|\mathbf{h}_i - \overline{\mathbf{p}}\| \le \text{head\_core\_max}$$

### é‡è¯•æœºåˆ¶

è‹¥ç”Ÿæˆçš„ç§å­ä¸é€šè¿‡è¿‡æ»¤ï¼Œè‡ªåŠ¨é‡æ–°ç”Ÿæˆï¼Œç›´åˆ°ï¼š
- è¾¾åˆ° `nseeds` ä¸ªæœ‰æ•ˆç§å­
- æˆ–è¾¾åˆ° `max_attempts` æ¬¡å°è¯•ä¸Šé™

### è¿‡æ»¤ç»Ÿè®¡è¾“å‡º

```
[FILTER STATS]
  Accepted: 100
  Rejected (Rg): 12
  Rejected (Contacts): 8
  Rejected (Duplicate): 5
  Rejected (PT core dist): 3
```

---

## é…ç½®ä¸å‚æ•°

### config.json ç»“æ„

```json
{
  "molecules": [
    {
      "name": "PT",
      "file": "monomer/opt-PT-B97-3c.xyz",
      "count": 2,
      "enabled": true,
      "description": "Platinum ester cluster"
    },
    {
      "name": "H2SO4",
      "file": "monomer/opt-cisSA-B97-3c.xyz",
      "count": 1,
      "enabled": true,
      "description": "Sulfuric acid"
    }
  ],
  "sampling_parameters": {
    "dmin": 10.0,
    "dmax": 15.0,
    "lateral": 3.0,
    "jitter_deg": 25.0,
    "clash_cut": 1.20,
    "max_trials_add": 2000
  },
  "_presets": {
    "balanced": {"dmin": 6.0, "dmax": 10.0, "lateral": 2.0},
    "compact": {"dmin": 4.0, "dmax": 8.0, "lateral": 1.0},
    "loose": {"dmin": 10.0, "dmax": 15.0, "lateral": 3.0}
  }
}
```

### å…³é”®å‚æ•°è¯´æ˜

| å‚æ•° | å•ä½ | è¯´æ˜ | æ¨èå€¼ï¼ˆçº¯PTï¼‰ | æ¨èå€¼ï¼ˆæ··åˆï¼‰ |
|------|------|------|---------------|---------------|
| `dmin` | Ã… | COM è·ç¦»ä¸‹é™ | 10.0 | 7.0-8.0 |
| `dmax` | Ã… | COM è·ç¦»ä¸Šé™ | 15.0 | 10.0-11.0 |
| `lateral` | Ã… | ä¾§å‘ä½ç§»æœ€å¤§å€¼ | 3.0 | 1.5-2.0 |
| `jitter_deg` | Â° | æŠ–åŠ¨è§’èŒƒå›´ | 25.0 | 25.0 |
| `clash_cut` | Ã… | ç¢°æ’é˜ˆå€¼ | 1.20 | 1.20 |
| `max_trials_add` | count | å•åˆ†å­æœ€å¤§å°è¯•æ¬¡æ•° | 2000 | 2000 |
| `core_dist_max` | Ã… | PT æ ¸å¿ƒé—´æœ€å¤§è·ç¦» | â€” | 6.0-8.0 |
| `head_core_max` | Ã… | éPTå¤´åˆ°PTæ ¸å¿ƒæœ€å¤§è·ç¦» | â€” | 5.0-6.0 |
| `pt_k` | count | PT æ ¸å¿ƒ O åŸå­æ•° | 8 | 8 |

### é¢„è®¾é…ç½®æ¯”è¾ƒ

| é¢„è®¾ | å¹³å‡é—´è· | æˆåŠŸç‡ | ç”¨é€” |
|------|---------|--------|------|
| **balanced** âœ… | ~8 Ã… | 85% | **é€šç”¨æ¨è** |
| compact | ~6 Ã… | 70% | å¼ºç›¸äº’ä½œç”¨ |
| loose | ~12 Ã… | 95% | æµ‹è¯•/å¼±ç›¸äº’ä½œç”¨ |

---

## ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ—å‡ºå¯ç”¨åˆ†å­

```bash
python main.py --list-monomers
```

è¾“å‡ºï¼š
```
[AVAILABLE MONOMERS]
  cisSA                <- opt-cisSA-B97-3c.xyz
  NO                   <- opt-NO-B97-3c.xyz
  NO2                  <- opt-NO2-B97-3c.xyz
  PT                   <- opt-PT-B97-3c.xyz
  SO2                  <- opt-SO2-B97-3c.xyz
  transSA              <- opt-transSA-B97-3c.xyz
```

### 2. å¿«é€Ÿç”Ÿæˆï¼ˆé»˜è®¤é…ç½®ï¼‰

```bash
# ä½¿ç”¨ config.json ä¸­çš„æ‰€æœ‰å¯ç”¨åˆ†å­
python main.py --nseeds 100
```

### 3. é€‰æ‹©ç‰¹å®šåˆ†å­

```bash
# åªä½¿ç”¨ PT å’Œ H2SO4
python main.py --use "PT,H2SO4" --nseeds 50

# è‡ªå®šä¹‰æ•°é‡
python main.py --use "PT,H2SO4,NO2" \
  --counts "PT=2,H2SO4=1,NO2=1" --nseeds 100
```

### 4. å¯ç”¨è¿‡æ»¤

```bash
python main.py --use "PT,H2SO4,NO,NO2" \
  --counts "PT=2,H2SO4=1,NO=2,NO2=1" \
  --enable_filter \
  --min_contacts 20 \
  --max_rg 25.0 \
  --core_dist_max 8.0 \
  --head_core_max 6.0 \
  --nseeds 200
```

### 5. å¾®è°ƒè·ç¦»å‚æ•°

```bash
# æ”¶ç´§è·ç¦»ï¼ˆæ›´ç´§å¯†çš„èšç±»ï¼‰
python main.py --use "PT,H2SO4" \
  --dmin 7.0 --dmax 10.0 --lateral 1.5 \
  --nseeds 100

# æ”¾æ¾è·ç¦»ï¼ˆæ›´åˆ†æ•£çš„èšç±»ï¼‰
python main.py --use "PT,H2SO4" \
  --dmin 12.0 --dmax 18.0 --lateral 4.0 \
  --nseeds 100
```

### 6. å¹¶è¡Œé‡‡æ ·ï¼ˆå¤šæ ¸ï¼‰

```bash
# ä½¿ç”¨ 4 ä¸ªå·¥ä½œè¿›ç¨‹å¹¶è¡Œç”Ÿæˆ
python main.py --use "PT,H2SO4,NO2" \
  --sampling-workers 4 --nseeds 500
```

### 7. HPC æ‰¹é‡æäº¤

ç¼–è¾‘ `sbatch_sampling.sh`ï¼š
```bash
#!/bin/bash
#SBATCH --nodes=1
#SBATCH --ntasks=1
#SBATCH --cpus-per-task=8
#SBATCH --time=02:00:00

python main.py --use "PT,H2SO4,NO,NO2" \
  --counts "PT=2,H2SO4=1,NO=2,NO2=1" \
  --sampling-workers 8 \
  --enable_filter \
  --nseeds 1000
```

æäº¤ä»»åŠ¡ï¼š
```bash
sbatch sbatch_sampling.sh
```

---

## æ·»åŠ æ–°åˆ†å­

### å•ä½“åº“ï¼ˆmonomer/ï¼‰

å½“å‰æ”¯æŒçš„åˆ†å­ï¼š
- âœ… PT (Platinum ester)
- âœ… H2SO4 (Sulfuric acid, cis-SA)
- âœ… trans-SA (Trans sulfuric acid)
- âœ… NO (Nitric oxide)
- âœ… NO2 (Nitrogen dioxide)
- âœ… SO2 (Sulfur dioxide)

### æ·»åŠ æµç¨‹

#### 1. å‡†å¤‡åˆ†å­ç»“æ„

ä½¿ç”¨é‡å­åŒ–å­¦è½¯ä»¶ä¼˜åŒ–åˆ†å­ç»“æ„ï¼ˆå¦‚ ORCA, Gaussian, xTBï¼‰ï¼š

```bash
# ä½¿ç”¨ xTB ä¼˜åŒ–ï¼ˆç¤ºä¾‹ï¼‰
xtb molecule.xyz --opt --gfn 2
```

å¯¼å‡ºä¸º XYZ æ ¼å¼ã€‚

#### 2. æ”¾ç½®åˆ° monomer/ ç›®å½•

```bash
cp molecule.xyz monomer/opt-MOLECULE-B97-3c.xyz
```

å‘½åè§„åˆ™ï¼š
- å‰ç¼€ `opt-`ï¼šè¡¨ç¤ºå·²ä¼˜åŒ–
- ä¸­ç¼€ï¼šåˆ†å­åç§°ï¼ˆå¯åŒ…å«ä¸‹åˆ’çº¿/è¿å­—ç¬¦ï¼‰
- åç¼€ `-B97-3c` æˆ– `-B3LYP` ç­‰ï¼šè¡¨ç¤ºè®¡ç®—æ–¹æ³•ï¼ˆå¯é€‰ï¼‰
- æ‰©å±•åï¼š`.xyz`

#### 3. æ›´æ–° config.json

```json
{
  "molecules": [
    {
      "name": "MOLECULE",
      "file": "monomer/opt-MOLECULE-B97-3c.xyz",
      "count": 1,
      "enabled": true,
      "description": "Your molecule description"
    },
    // ... å…¶ä»–åˆ†å­
  ]
}
```

#### 4. æµ‹è¯•

```bash
python main.py --use "MOLECULE,PT" --nseeds 10
```

### åˆ†å­ç±»å‹æ”¯æŒ

ç³»ç»Ÿæ ¹æ®**å¼‚åŸå­ä¼˜å…ˆçº§**è‡ªåŠ¨è¯†åˆ«å¤´ç‚¹ï¼š

| åˆ†å­ç±»å‹ | å¼‚åŸå­ | ç¤ºä¾‹ | å¤´ç‚¹å®šä¹‰ |
|---------|-------|------|---------|
| å«æ°§åˆ†å­ | O | H2SO4, H2O, é†‡ç±», é…¸ç±» | O åŸå­è´¨å¿ƒ |
| å«æ°®åˆ†å­ | N | NH3, èƒºç±», NO, NO2 | N åŸå­è´¨å¿ƒ |
| å«ç¡«åˆ†å­ | S | H2S, ç¡«é†‡, SO2 | S åŸå­è´¨å¿ƒ |
| çƒƒç±» | æ—  | CH4, è‹¯ | æ‰€æœ‰åŸå­ä¸­å¿ƒ |

**é²æ£’æ€§ä¿è¯**ï¼šå³ä½¿åˆ†å­å¯¹ç§°æˆ–æ— å¼‚åŸå­,ç®—æ³•ä¹Ÿèƒ½æ‰¾åˆ°åˆç†çš„å¤´å‘é‡ã€‚

---

## æ•°å­¦åŸç†

è¯¦è§ [docs/ALGORITHM.md](docs/ALGORITHM.md)ï¼ŒåŒ…æ‹¬ï¼š

- **å‡ ä½•å˜æ¢**ï¼šè´¨å¿ƒã€å¤´å‘é‡ã€Rodrigues æ—‹è½¬å…¬å¼
- **PT é…¯æ ¸å¿ƒ**ï¼š$k$ è¿‘é‚» O åŸå­è´¨å¿ƒç®—æ³•
- **Head-Insert æ•°å­¦å½¢å¼åŒ–**ï¼šæ—‹è½¬çŸ©é˜µã€ä¾§å‘æ‰°åŠ¨ã€åæ ‡å˜æ¢
- **è¿‡æ»¤å‡½æ•°**ï¼šRg è®¡ç®—ã€æ¥è§¦è®¡æ•°ã€è·ç¦»ç›´æ–¹å›¾æŒ‡çº¹
- **çº¦æŸä¼˜åŒ–**ï¼šè·ç¦»èŒƒå›´è‡ªé€‚åº”ã€å†²çªè§£å†³
- **è®¡ç®—å¤æ‚åº¦åˆ†æ**ï¼šæ—¶é—´å¤æ‚åº¦ O(NÂ²M)

æ ¸å¿ƒå…¬å¼ç¤ºä¾‹ï¼š

**å¤´å‘é‡**ï¼š
$$\mathbf{v}_h = \frac{\mathbf{h} - \mathbf{c}}{\|\mathbf{h} - \mathbf{c}\|}, \quad \mathbf{h} = \frac{1}{n} \sum_{i \in I_{\text{hetero}}} \mathbf{r}_i$$

**PT é…¯æ ¸å¿ƒ**ï¼š
$$\mathbf{p}_{\text{core}} = \frac{1}{k} \sum_{i \in I_{\text{O}}^{(k)}} \mathbf{r}_i$$

**å›æ—‹åŠå¾„**ï¼š
$$\text{Rg} = \sqrt{\frac{1}{N} \sum_{i=1}^{N} \|\mathbf{r}_i - \overline{\mathbf{r}}\|^2}$$

---

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

#### Q1: ç”Ÿæˆ 0 ä¸ªç§å­

**ç°è±¡**ï¼š
```
Done. Generated 0 cluster seeds in out/seeds
```

**åŸå› **ï¼š
- PT æ ¸å¿ƒè·ç¦»çº¦æŸè¿‡ç´§ï¼ˆ`core_dist_max` < `dmin`ï¼‰
- ç¢°æ’é˜ˆå€¼è¿‡ä¸¥ï¼ˆ`clash_cut` è¿‡å¤§ï¼‰
- è·ç¦»èŒƒå›´å†²çª

**è§£å†³**ï¼š
```bash
# æ–¹æ¡ˆ 1ï¼šæ”¾å®½ PT æ ¸å¿ƒçº¦æŸ
python main.py --use "PT,NO2" \
  --core_dist_max 10.0 --head_core_max 8.0 --nseeds 100

# æ–¹æ¡ˆ 2ï¼šè°ƒæ•´è·ç¦»èŒƒå›´
python main.py --use "PT,H2SO4" \
  --dmin 7.0 --dmax 11.0 --lateral 1.5 --nseeds 100

# æ–¹æ¡ˆ 3ï¼šé™ä½ç¢°æ’é˜ˆå€¼
python main.py --use "PT,H2SO4" \
  --clash_cut 1.0 --nseeds 100
```

#### Q2: åˆ†å­è¿‡äºåˆ†æ•£

**ç°è±¡**ï¼šèšç±»ä¸­åˆ†å­é—´è·è¿‡å¤§ï¼Œæ¥è§¦ä¸è¶³

**è§£å†³**ï¼š
```bash
# ä½¿ç”¨ç´§å¯†é¢„è®¾
python main.py --use "PT,H2SO4" \
  --dmin 6.0 --dmax 9.0 --lateral 1.5 --nseeds 100

# å¯ç”¨è¿‡æ»¤ä»¥å¼ºåˆ¶æ¥è§¦
python main.py --use "PT,H2SO4" \
  --enable_filter --min_contacts 25 --max_rg 20.0 --nseeds 100
```

#### Q3: è¿‡æ»¤æ‹’ç»ç‡è¿‡é«˜

**ç°è±¡**ï¼š
```
[FILTER STATS]
  Accepted: 50
  Rejected (Rg): 30
  Rejected (Contacts): 40
```

**è§£å†³**ï¼š
```bash
# æ”¾å®½è¿‡æ»¤æ¡ä»¶
python main.py --use "PT,H2SO4" \
  --enable_filter \
  --min_contacts 15 \    # é™ä½æœ€å°æ¥è§¦æ•°
  --max_rg 30.0 \        # æé«˜æœ€å¤§ Rg
  --core_dist_max 10.0 \ # æ”¾å®½æ ¸å¿ƒè·ç¦»
  --nseeds 100
```

#### Q4: æ— æ³•æ‰¾åˆ°å•ä½“æ–‡ä»¶

**ç°è±¡**ï¼š
```
[ERROR] No monomer file found for 'trans-SA' in monomer/
```

**è§£å†³**ï¼š
- æ£€æŸ¥ `monomer/` ç›®å½•ä¸­æ˜¯å¦æœ‰è¯¥æ–‡ä»¶
- ä½¿ç”¨ `--list-monomers` æŸ¥çœ‹å¯ç”¨åˆ†å­
- ç¡®ä¿æ–‡ä»¶å‘½åç¬¦åˆè§„èŒƒï¼ˆå¦‚ `opt-transSA-B97-3c.xyz`ï¼‰
- ç³»ç»Ÿä¼šè‡ªåŠ¨åŒ¹é… `transSA`ã€`trans-SA`ã€`trans_SA` ç­‰å˜ä½“

#### Q5: ç»“æ„ä¸åˆç†

**ç°è±¡**ï¼šç”Ÿæˆçš„èšç±»å‡ ä½•ä¸ç¬¦åˆåŒ–å­¦ç›´è§‰

**è§£å†³**ï¼š
```bash
# å¯ç”¨æ‰€æœ‰çº¦æŸå’Œè¿‡æ»¤
python main.py --use "PT,H2SO4,NO2" \
  --enable_filter \
  --min_contacts 25 \
  --max_rg 22.0 \
  --core_dist_max 7.0 \
  --head_core_max 5.5 \
  --rmsd_dedup 0.5 \
  --keep_best 100 \
  --nseeds 200
```

### è°ƒè¯•æŠ€å·§

#### 1. å°è§„æ¨¡æµ‹è¯•

```bash
# å…ˆç”Ÿæˆå°‘é‡ç§å­æµ‹è¯•å‚æ•°
python main.py --use "PT,H2SO4" --nseeds 5
```

#### 2. æ£€æŸ¥è¾“å‡º

```bash
# æŸ¥çœ‹ç”Ÿæˆçš„ç§å­æ•°é‡
ls -l out/seeds/seed_*.xyz | wc -l

# æŸ¥çœ‹ç¬¬ä¸€ä¸ªç§å­
head -20 out/seeds/seed_10001*.xyz
```

#### 3. å¯è§†åŒ–

ä½¿ç”¨åˆ†å­å¯è§†åŒ–è½¯ä»¶ï¼ˆJmol, Avogadro, VMDï¼‰æ‰“å¼€ï¼š
```bash
# æ‰“å¼€åˆå¹¶æ–‡ä»¶ï¼ˆå¤šå¸§ï¼‰
jmol out/seeds_PT_combined.xyz

# æ‰“å¼€å•ä¸ªç§å­
avogadro out/seeds/seed_10001_PT2_H2SO41.xyz
```

#### 4. æ—¥å¿—è¾“å‡º

```bash
# æŸ¥çœ‹è¯¦ç»†è¾“å‡ºï¼ˆåŒ…æ‹¬è¿‡æ»¤ç»Ÿè®¡ï¼‰
python main.py --use "PT,H2SO4" --enable_filter --nseeds 100 2>&1 | tee sampling.log
```

---

## è¾“å‡ºæ–‡ä»¶

### out/seeds/ ç›®å½•

æ¯ä¸ªç§å­ç”Ÿæˆä¸¤ä¸ªæ–‡ä»¶ï¼š

**1. å‡ ä½•æ–‡ä»¶ï¼ˆ.xyzï¼‰**
```
seed_10001_PT2_H2SO41_NO21.xyz
```
æ ¼å¼ï¼š
```
181
seed_10001_PT2_H2SO41_NO21 HeadInsert mixed
C     -2.12345678    1.23456789   -0.12345678
H     -1.98765432    2.01234567   -0.87654321
...
```

**2. çº¦æŸæ–‡ä»¶ï¼ˆ.xcontrolï¼‰**
```
seed_10001_PT2_H2SO41_NO21.xcontrol
```
æ ¼å¼ï¼ˆç”¨äº xTBï¼‰ï¼š
```
$constrain
  force constant=0.500
  distance: 14, 106, 3.400
  distance: 17, 103, 3.600
  distance: 22, 98, 3.350
  ...
$end
```

### out/ ç›®å½•

**å¤šå¸§åˆå¹¶æ–‡ä»¶**ï¼š
```
seeds_PT_combined.xyz
```
åŒ…å«æ‰€æœ‰ç§å­çš„åæ ‡ï¼Œå¯ç”¨äºæ‰¹é‡å¯è§†åŒ–å’Œåˆ†æã€‚

### out/seeds_xyz/ ç›®å½•ï¼ˆå¯é€‰ï¼‰

ä»å¤šå¸§æ–‡ä»¶æ‹†åˆ†çš„å•ä¸ªç§å­ï¼ˆå¦‚æœä½¿ç”¨æå–å·¥å…·ï¼‰ã€‚

---

## CLI å®Œæ•´å‚è€ƒ

```bash
python main.py [OPTIONS]

åˆ†å­é€‰æ‹©:
  --list-monomers              åˆ—å‡ºå¯ç”¨å•ä½“
  --use MOLECULES              é€‰æ‹©åˆ†å­ï¼ˆé€—å·åˆ†éš”ï¼‰
  --counts "MOL=N,..."         è¦†ç›–åˆ†å­æ•°é‡
  --config FILE                JSON é…ç½®æ–‡ä»¶
  --molecules JSON_STRING      å‘½ä»¤è¡Œ JSON åˆ†å­åˆ—è¡¨

é‡‡æ ·å‚æ•°:
  --nseeds N                   ç”Ÿæˆç§å­æ•°é‡ (default: 200)
  --seed SEED                  éšæœºç§å­ (default: 7)
  --dmin FLOAT                 æœ€å° COM è·ç¦» Ã… (default: 10.0)
  --dmax FLOAT                 æœ€å¤§ COM è·ç¦» Ã… (default: 15.0)
  --lateral FLOAT              ä¾§å‘ä½ç§»æœ€å¤§å€¼ Ã… (default: 3.0)
  --jitter_deg FLOAT           æŠ–åŠ¨è§’åº¦ Â° (default: 25.0)
  --clash_cut FLOAT            ç¢°æ’é˜ˆå€¼ Ã… (default: 1.20)
  --max_trials_add INT         å•åˆ†å­æœ€å¤§å°è¯•æ¬¡æ•° (default: 2000)

è¿‡æ»¤å‚æ•°:
  --enable_filter              å¯ç”¨åå¤„ç†è¿‡æ»¤
  --contact_cut FLOAT          æ¥è§¦è·ç¦»é˜ˆå€¼ Ã… (default: 3.8)
  --min_contacts INT           æœ€å°æ¥è§¦æ•° (default: 20)
  --max_rg FLOAT               æœ€å¤§å›æ—‹åŠå¾„ Ã… (default: 25.0)
  --rmsd_dedup FLOAT           RMSD å»é‡é˜ˆå€¼ï¼ˆå¯é€‰ï¼‰
  --keep_best INT              ä¿ç•™æœ€ä¼˜ N ä¸ªï¼ˆå¯é€‰ï¼‰
  --max_attempts INT           æœ€å¤§ç”Ÿæˆå°è¯•æ¬¡æ•° (default: 10000)

PT ç‰¹å®šå‚æ•°:
  --core_dist_max FLOAT        PT æ ¸å¿ƒé—´æœ€å¤§è·ç¦» Ã… (default: 8.0)
  --head_core_max FLOAT        éPTå¤´åˆ°PTæ ¸å¿ƒæœ€å¤§è·ç¦» Ã… (default: 6.0)
  --pt_k INT                   PT æ ¸å¿ƒ O åŸå­æ•° (default: 8)

æ€§èƒ½:
  --sampling-workers INT       å¹¶è¡Œé‡‡æ ·è¿›ç¨‹æ•° (default: 1)
  --workers INT                æ–‡ä»¶æå–çº¿ç¨‹æ•° (default: 1)

è¾“å‡º:
  --out DIR                    è¾“å‡ºç›®å½• (default: out)
```

---

## æŠ€æœ¯ç»†èŠ‚

### ä¾èµ–

- Python 3.8+
- NumPy 1.20+

### å®‰è£…

```bash
# å…‹éš†æˆ–ä¸‹è½½é¡¹ç›®
cd sampling

# å®‰è£…ä¾èµ–
pip install numpy

# æµ‹è¯•
python main.py --list-monomers
```

### æ€§èƒ½

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | å¤‡æ³¨ |
|------|-----------|------|
| å•ä¸ªåˆ†å­ Head-Insert | O(NM) | N=é”šåŸå­æ•°, M=æ–°åŸå­æ•° |
| ä¸€ä¸ªç§å­ç”Ÿæˆ | O(LÂ·NM) | L=æ€»åˆ†å­æ•° |
| åè¿‡æ»¤ | O(NÂ²) | N=æ€»åŸå­æ•° |
| æ•´ä½“ï¼ˆnseedsä¸ªï¼‰ | O(nseedsÂ·LÂ·NM) | å¯å¹¶è¡ŒåŒ– |

**å¹¶è¡ŒåŠ é€Ÿ**ï¼š
- ä½¿ç”¨ `--sampling-workers N` å¯çº¿æ€§åŠ é€Ÿï¼ˆç†æƒ³æƒ…å†µï¼‰
- æ¨èå€¼ï¼šCPU æ ¸å¿ƒæ•°çš„ 50-75%

### å†ç°æ€§

æ‰€æœ‰éšæœºæ“ä½œåŸºäºç¡®å®šæ€§ PRNGï¼š
```python
rng = np.random.default_rng(seed + s)
```
ç›¸åŒçš„ `--seed` å‚æ•°äº§ç”Ÿç›¸åŒçš„ç»“æœã€‚

---

## ç‰ˆæœ¬å†å²

- **v2.0** (2026-01-15)
  - æ·»åŠ  PT é…¯æ ¸å¿ƒæ”¾ç½®ç­–ç•¥ï¼ˆä¸‰åˆ†æ”¯ï¼‰
  - å®ç°åå¤„ç†è¿‡æ»¤ç³»ç»Ÿï¼ˆRg/æ¥è§¦/å»é‡/PTçº¦æŸï¼‰
  - æ·»åŠ å•ä½“å‘ç°ä¸åˆ†å­é€‰æ‹©ï¼ˆ--use, --countsï¼‰
  - æ”¯æŒ 6 ç§å•ä½“åˆ†å­
  - è·ç¦»èŒƒå›´è‡ªé€‚åº”
  - å®Œæ•´æ•°å­¦æ–‡æ¡£

- **v1.4** (Previous)
  - Head-Insert åŸºç¡€ç®—æ³•
  - å¼‚åŸå­å¤´ç‚¹æ£€æµ‹
  - å¤šåˆ†å­æ”¯æŒ
  - çº¦æŸç”Ÿæˆ

---

## å¼•ç”¨ä¸å‚è€ƒ

å¦‚åœ¨ç ”ç©¶ä¸­ä½¿ç”¨æœ¬ç³»ç»Ÿï¼Œè¯·å¼•ç”¨ï¼š

```bibtex
@software{multi_molecule_sampling,
  title = {Multi-Molecule Cluster Sampling System},
  author = {Research Team},
  year = {2026},
  version = {2.0},
  url = {https://...}
}
```

**ç›¸å…³ç®—æ³•**ï¼š
- Head-Insert ç­–ç•¥æºäºç»“æ„é¢„æµ‹æ–‡çŒ®
- Rodrigues æ—‹è½¬å…¬å¼ï¼ˆ1840ï¼‰
- AMBER/OPLS åŠ›åœºæ¥è§¦å®šä¹‰

---

## æ”¯æŒ

- **æ–‡æ¡£**ï¼š[docs/ALGORITHM.md](docs/ALGORITHM.md)ï¼ˆæ•°å­¦åŸç†ï¼‰
- **ç¤ºä¾‹**ï¼šconfig.jsonï¼ˆå®Œæ•´é…ç½®ç¤ºä¾‹ï¼‰
- **æµ‹è¯•**ï¼š`tools/smoke_test.py`ï¼ˆå¿«é€ŸéªŒè¯ï¼‰

---

**æœ€åæ›´æ–°**: 2026-01-15 | **çŠ¶æ€**: ç”Ÿäº§å°±ç»ª âœ…
